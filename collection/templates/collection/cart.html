<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shopping Cart – Rare Hunter TCG</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">

<div class="max-w-5xl mx-auto px-4 py-6">
  <a href="/" class="text-sm text-zinc-400 hover:underline">← Back to store</a>
  <h1 class="text-3xl font-bold mt-4">Your Cart</h1>
  <div id="cartFeedback" class="fixed top-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  {% if items %}
  <div class="mt-6 space-y-4">
    {% for item in items %}
    <div class="cart-item flex items-center justify-between bg-zinc-900 rounded-lg p-4" data-id="{{ item.collection_card.id }}">
      <div class="flex items-center gap-4">
        {% if item.collection_card.images.exists %}
          <img src="{{ item.collection_card.images.first.img.url }}" alt="{{ item.collection_card.card.name }}" class="w-20 h-28 object-cover rounded" />
        {% else %}
          <img src="{{ item.collection_card.card.image }}" alt="{{ item.collection_card.card.name }}" class="w-20 h-28 object-cover rounded" />
        {% endif %}
        <div>
          <h2 class="text-lg font-semibold">{{ item.collection_card.card.name }}</h2>
          <div class="text-sm text-zinc-400">{{ item.collection_card.edition }} • {{ item.collection_card.condition }}</div>
          <div class="mt-1 flex items-center gap-2">
  <button class="qty-minus" data-id="{{ item.collection_card.id }}">-</button>
  <span id="qty-{{ item.collection_card.id }}">{{ item.quantity }}</span>
  <button class="qty-plus" data-id="{{ item.collection_card.id }}">+</button>
  <span id="itemFeedback-{{ item.collection_card.id }}" class="ml-2 text-sm text-yellow-400"></span>
</div>

        </div>
      </div>
      <div class="text-right">
        <div class="text-lg font-bold">${{ item.subtotal|floatformat:2 }}</div>
        <button class="remove-item" data-id="{{ item.collection_card.id }}">Remove</button>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="mt-6 flex justify-between items-center">
    <div class="text-xl font-bold">Total: ${{ total|floatformat:2 }}</div>
    <button id="checkoutBtn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md text-white font-semibold">
      Checkout
    </button>
  </div>

  {% else %}
    <div class="mt-6 text-zinc-400">Your cart is empty.</div>
  {% endif %}
</div>

 <!-- Footer -->
<footer class="mt-12 border-t border-zinc-800 pt-4 pb-4 text-zinc-400 text-sm">
  <div class="max-w-7xl mx-auto px-4 flex flex-col items-center gap-2">
    <!-- Brand + Date -->
    <div class="text-center font-semibold">
      Rare Hunter - TCG &copy; <span id="currentYear"></span>
    </div>

    <!-- Links -->
    <div class="flex flex-wrap justify-center gap-3 text-xs">
      <a href="/" class="hover:text-indigo-500 transition">Collection</a>
      <a href="/about" class="hover:text-indigo-500 transition">About</a>
      <a href="/terms" class="hover:text-indigo-500 transition">Terms</a>
      <a href="/privacy" class="hover:text-indigo-500 transition">Privacy</a>
      <a href="https://instagram.com/rarehunter.tcg" target="_blank" class="hover:text-indigo-500 transition">Instagram</a>
    </div>
  </div>
</footer>

<script>
  // Automatically set the current year
  document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

<script>
(function () {
  window.CSRF = window.CSRF || (document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '');
  document.addEventListener('DOMContentLoaded', () => {
    window.cartFeedback = document.getElementById('cartFeedback');

    window.showFeedback = function (message, isError=false) {
      const el = window.cartFeedback;
      if (!el) return;
      el.textContent = message;
      el.classList.remove('opacity-0', 'bg-red-600', 'bg-indigo-600');
      el.classList.add(isError ? 'bg-red-600' : 'bg-indigo-600', 'opacity-100');
      setTimeout(() => {
        el.classList.remove('opacity-100');
        el.classList.add('opacity-0');
      }, 2000);
    };

    async function safeFetch(url, opts) {
      const res = await fetch(url, opts);
      let data;
      try { data = await res.json(); } catch(e) { data = null; }
      return { res, data };
    }

    async function updateCart(collectionCardId, change) {
      const qtyEl = document.getElementById(`qty-${collectionCardId}`);
      if (!qtyEl) return;
      const currentQty = parseInt(qtyEl.textContent) || 0;
      if (currentQty + change < 0) return;

      const { res, data } = await safeFetch('/cart/add/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': window.CSRF
        },
        body: JSON.stringify({ collection_card_id: collectionCardId, quantity: change })
      });

      if (res.ok) {
        const newQty = data?.cart && data.cart[String(collectionCardId)];
        if (!newQty || newQty <= 0) {
          document.querySelector(`.cart-item[data-id='${collectionCardId}']`)?.remove();
          window.showFeedback("Item removed (sold out/reserved)", true);
        } else {
          qtyEl.textContent = newQty;
          window.showFeedback("Cart updated!");
        }
        refreshTotals();
      } else {
        window.showFeedback(data?.error || "Cannot update item", true);
      }
    }

    async function removeFromCart(collectionCardId) {
      const { res, data } = await safeFetch('/cart/remove/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': window.CSRF
        },
        body: JSON.stringify({ collection_card_id: collectionCardId })
      });

      if (res.ok) {
        document.querySelector(`.cart-item[data-id='${collectionCardId}']`)?.remove();
        window.showFeedback("Removed from cart");
        refreshTotals();
      } else {
        window.showFeedback(data?.error || "Failed to remove item", true);
      }
    }

    async function refreshTotals() {
      const { res, data } = await safeFetch('/cart/status/', { credentials: 'same-origin' });
      if (!res.ok || !data) return;

      // Update each cart item
      let cartBlocked = false;
      for (const [cardId, qty] of Object.entries(data.cart || {})) {
        const qtyEl = document.getElementById(`qty-${cardId}`);
        const itemEl = document.querySelector(`.cart-item[data-id='${cardId}']`);
        if (!qtyEl || !itemEl) continue;

        if (qty <= 0) {
          itemEl.remove();
          window.showFeedback("Item removed (sold out/reserved)", true);
          cartBlocked = true;
        } else {
          qtyEl.textContent = qty;
        }
      }

      // Update total display
      const totalEl = document.querySelector('.text-xl.font-bold');
      if (totalEl && data.total !== undefined) totalEl.textContent = `Total: $${data.total.toFixed(2)}`;

      // Disable checkout if any items removed or cart empty
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        const anyItems = Object.values(data.cart || {}).some(q => q > 0);
        checkoutBtn.disabled = !anyItems;
        checkoutBtn.classList.toggle('opacity-50', !anyItems);
        checkoutBtn.classList.toggle('cursor-not-allowed', !anyItems);
      }
    }

    // Event delegation for +/- and remove
    document.addEventListener('click', e => {
      const t = e.target;
      if (t.matches('.qty-minus')) updateCart(t.dataset.id, -1);
      else if (t.matches('.qty-plus')) updateCart(t.dataset.id, 1);
      else if (t.matches('.remove-item')) removeFromCart(t.dataset.id);
    });

    // Poll cart every second
    // Poll every second and remove unavailable items
setInterval(async () => {
  try {
    const { res, data: products } = await safeFetch('/api/products/', { credentials: 'same-origin' });
    if (!res.ok || !products) return;

    let cartChanged = false;

    document.querySelectorAll('.cart-item').forEach(itemEl => {
      const cardId = itemEl.dataset.id;
      const product = products.find(p => String(p.id) === cardId);
      if (!product) return;

      const availableQty = (product.available ?? 0) - (product.reserved ?? 0);

      if (availableQty <= 0 || product.is_sold_out || product.is_reserved) {
        itemEl.remove();
        cartChanged = true;
        window.showFeedback("Item removed (sold out/reserved)", true);
      }
    });

    if (cartChanged) refreshTotals();
  } catch (err) {
    console.error("Cart polling failed:", err);
  }
}, 1000);


    // Checkout handler
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', async () => {
        const { res, data } = await safeFetch('/cart/status/', { credentials: 'same-origin' });
        if (!res.ok || !data) { window.showFeedback("Cannot verify cart", true); return; }

        // Prevent checkout if any items unavailable
        const unavailable = Object.entries(data.cart || {}).filter(([_, qty]) => qty <= 0);
        if (unavailable.length > 0) {
          window.showFeedback("Some items are no longer available", true);
          unavailable.forEach(([cardId]) => document.querySelector(`.cart-item[data-id='${cardId}']`)?.remove());
          refreshTotals();
          return;
        }

        // Start checkout
        window.showFeedback("Starting checkout...");
        const { res: res2, data: data2 } = await safeFetch('/cart/checkout/', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': window.CSRF },
          body: JSON.stringify({})
        });

        if (res2.ok && data2?.url) window.location.href = data2.url;
        else window.showFeedback(data2?.error || "Failed to start checkout", true);
      });
    }

    // Initial totals refresh
    refreshTotals();
  });
})();
</script>




</body>
</html>
