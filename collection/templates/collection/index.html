<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rare Hunter TCG — Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-shadow { box-shadow: 0 8px 24px rgba(2,6,23,0.6); }
    .img-zoom { transition: transform .35s ease; }
    .img-zoom:hover { transform: scale(1.06); }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { background-position: -200px 0 } 100% { background-position: 200px 0 } }
  </style>
</head>

<body class="bg-zinc-950 text-zinc-100 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- Header -->
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Rare Hunter TCG</h1>
      <p class="text-sm text-zinc-400 mt-1">Vintage singles • holos • 1st editions</p>
    </div>
    <div class="flex gap-2 items-center">
      <div class="text-sm text-zinc-400 hidden sm:block">Showing <span id="displayCount">0</span></div>
      <button id="refreshBtn" class="px-3 py-2 rounded bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 text-sm">Refresh</button>
    </div>
  </header>

  <!-- Controls -->
  <section class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
    <div class="md:col-span-2 flex gap-3">
      <div class="flex-1">
        <label for="search" class="sr-only">Search</label>
        <input id="search" type="search" placeholder="Search name, konami id, set, edition..." class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      </div>
      <select id="sort" aria-label="Sort" class="px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-800">
        <option value="featured">Featured</option>
        <option value="price_asc">Price: Low → High</option>
        <option value="price_desc">Price: High → Low</option>
      </select>
    </div>
    <select id="setFilter" class="px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-800">
      <option value="">All Sets</option>
    </select>
  </section>

  <!-- Grid -->
  <main>
    <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

    <!-- Load more -->
    <div class="mt-6 flex items-center justify-center gap-3">
      <button id="loadMore" class="px-5 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold">Load more</button>
    </div>
  </main>
</div>

<!-- Footer -->
<footer class="mt-12 border-t border-zinc-800 pt-4 pb-4 text-zinc-400 text-sm">
  <div class="max-w-7xl mx-auto px-4 flex flex-col items-center gap-2">
    <!-- Brand + Date -->
    <div class="text-center font-semibold">
      Rare Hunter - TCG &copy; <span id="currentYear"></span>
    </div>

    <!-- Links -->
    <div class="flex flex-wrap justify-center gap-3 text-xs">
      <a href="/" class="hover:text-indigo-500 transition">Collection</a>
      <a href="/about" class="hover:text-indigo-500 transition">About</a>
      <a href="/terms" class="hover:text-indigo-500 transition">Terms</a>
      <a href="/privacy" class="hover:text-indigo-500 transition">Privacy</a>
      <a href="https://instagram.com/rarehunter.tcg" target="_blank" class="hover:text-indigo-500 transition">Instagram</a>
    </div>
  </div>
</footer>

<script>
  // Automatically set the current year
  document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

<script>
const API_LIST = '/api/products/';
const CHECKOUT = '/api/create-checkout-session/';

let allProducts = [];
let visibleCount = 24;

// HELPERS
function escapeHtml(s){ return s ? String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') : ''; }
function formatMoney(cents){ return (cents!==null && cents!==undefined) ? '$'+(cents/100).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) : '—'; }
function el(id){ return document.getElementById(id); }

// SKELETON
function showSkeleton(count=12){
  const grid = el('grid'); grid.innerHTML='';
  for(let i=0;i<count;i++){
    const card = document.createElement('div');
    card.className='bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden animate-pulse';
    card.innerHTML=`<div style="aspect-ratio:4/5" class="skeleton"></div><div class="p-3 space-y-2"><div class="h-4 w-3/4 skeleton rounded"></div><div class="h-3 w-1/2 skeleton rounded"></div><div class="h-4 w-1/3 skeleton rounded mt-3"></div></div>`;
    grid.appendChild(card);
  }
}

// LOAD PRODUCTS
async function loadProducts(){
  showSkeleton(10);
  try{
    const res = await fetch(API_LIST,{credentials:'same-origin'});
    allProducts = await res.json();
    populateSets(); render();
    el('displayCount').textContent = allProducts.length;
  }catch(e){
    el('grid').innerHTML=`<div class="col-span-full p-6 text-center text-red-400">Could not load products: ${escapeHtml(e.message)}</div>`;
    console.error(e);
  }
}

// POPULATE SETS
function populateSets(){
  const sel = el('setFilter');
  sel.innerHTML = '<option value="">All Sets</option>';
  const sets = [...new Set(allProducts.map(p=>p.set?.name).filter(Boolean))].sort();
  sets.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; sel.appendChild(opt); });
}

// BUILD CARD
function buildCard(p){
  const quantity = typeof p.quantity==='number'?p.quantity:(typeof p.available==='number'?p.available:null);
  const reserved = Number(p.reserved||0);
  const available = typeof p.available==='number'?p.available:Math.max(0,(quantity||0)-reserved);
  const status = p.is_sold_out?'soldout':p.is_reserved?'reserved':'available';

  const card = document.createElement('article');
  // make it a column flex; inner content grows so actions stay at bottom
  card.className='bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden flex flex-col card-shadow';
  card.innerHTML=`
    <a href="/api/card/${p.id}/" class="block relative">
      <div style="aspect-ratio:4/5" class="relative bg-zinc-800 overflow-hidden">
        <img data-src="${escapeHtml(p.image||'')}" alt="${escapeHtml(p.name)}" class="img-zoom w-full h-full object-cover" loading="lazy" />
        <div class="absolute left-3 top-3 px-2 py-1 rounded-full text-xs font-semibold ${status==='available'?'bg-emerald-100 text-emerald-900':status==='reserved'?'bg-amber-100 text-amber-900':'bg-red-100 text-red-900'}">
          ${status==='available'?'Available':status==='reserved'?'Reserved':'Sold out'}
        </div>
        <div class="absolute right-3 top-3 px-2 py-1 rounded bg-zinc-900/60 text-xs">${escapeHtml(p.set?.code||'')}</div>
      </div>
    </a>

    <div class="p-3 flex flex-col gap-2 flex-1"> <!-- flex-1 makes the content stretch -->
      <a href="/api/card/${p.id}/" class="font-semibold hover:underline">${escapeHtml(p.name)}</a>
      <div class="text-zinc-400 text-xs">${escapeHtml(p.set?.name||'')} ${p.edition?'• '+escapeHtml(p.edition):''} ${p.condition?'• '+escapeHtml(p.condition):''}</div>
      ${p.misprint ? `<div class="text-yellow-400 text-xs mt-1">⚠ Misprint: ${escapeHtml(p.misprint)}</div>` : ''}

      <div class="flex items-center justify-between mt-2">
        <div class="text-lg font-bold">${formatMoney(p.price_cents)}</div>
      </div>

      <div class="mt-3"></div> <!-- flexible spacer if needed -->

      <!-- ACTIONS: always anchored to bottom -->
      <div class="mt-auto">
        
        ${p.is_sold_out?`<div class="px-3 py-2 bg-red-700 text-white rounded text-center font-semibold">Sold out</div>`:
          p.is_reserved?`<div class="px-3 py-2 bg-amber-500 text-zinc-900 rounded text-center font-semibold">Reserved</div>`:
          `<button class="buy-btn w-full px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 font-semibold" data-id="${p.id}">Request to buy</button>`}
      </div>
    </div>
  `;
  const imgEl=card.querySelector('img');
  imgObserver.observe(imgEl);
  const buyBtn=card.querySelector('.buy-btn');
  if(buyBtn) buyBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); ev.preventDefault(); buyItem(p.id); });
  return card;
}

// lazy load images
const imgObserver=new IntersectionObserver((entries, obs)=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const img=e.target; const src=img.getAttribute('data-src');
      if(src) img.src=src; obs.unobserve(img);
    }
  });
},{rootMargin:'200px'});

// RENDER GRID
function render(){
  const grid=el('grid');
  const q=el('search').value.trim().toLowerCase();
  const set=el('setFilter').value;
  const sort=el('sort').value;
  grid.innerHTML='';

  let filtered=allProducts.filter(p=>(!q||p.name.toLowerCase().includes(q)||String(p.konami_id||'').includes(q))&&(!set||(p.set&&p.set.name===set)));

  if(sort==='price_asc') filtered.sort((a,b)=>(a.price_cents||0)-(b.price_cents||0));
  else if(sort==='price_desc') filtered.sort((a,b)=>(b.price_cents||0)-(a.price_cents||0));

  const pageItems=filtered.slice(0,visibleCount);
  pageItems.forEach(p=>grid.appendChild(buildCard(p)));
  el('displayCount').textContent=filtered.length;
  el('loadMore').style.display=(filtered.length>visibleCount)?'inline-block':'none';
}

// BUY
async function buyItem(id){
  try{
    const res=await fetch(CHECKOUT,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/json'},body:JSON.stringify({collection_card_id:id,quantity:1})});
    const j=await res.json();
    if(j.url) window.location=j.url;
    else alert(j.error||'Checkout failed');
  }catch(e){ alert('Checkout error: '+e.message); }
}

async function refreshStatuses() {
  try {
    const res = await fetch(API_LIST, {credentials: 'same-origin'});
    const latestProducts = await res.json();

    latestProducts.forEach(p => {
      const card = document.querySelector(`.buy-btn[data-id="${p.id}"]`)?.closest('article');
      if (!card) return; // card not in DOM yet

      const actionDiv = card.querySelector('div.mt-auto');
      if (!actionDiv) return;

      const quantity = typeof p.quantity==='number'?p.quantity:(typeof p.available==='number'?p.available:null);
      const reserved = Number(p.reserved||0);
      const available = typeof p.available==='number'?p.available:Math.max(0,(quantity||0)-reserved);
      const status = p.is_sold_out?'soldout':p.is_reserved?'reserved':'available';

      // update button or label dynamically
      actionDiv.innerHTML = status==='soldout'
        ? `<div class="px-3 py-2 bg-red-700 text-white rounded text-center font-semibold">Sold out</div>`
        : status==='reserved'
        ? `<div class="px-3 py-2 bg-amber-500 text-zinc-900 rounded text-center font-semibold">Reserved</div>`
        : `<button class="buy-btn w-full px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 font-semibold" data-id="${p.id}">Request to buy</button>`;

      // reattach event listener if button exists
      const buyBtn = actionDiv.querySelector('.buy-btn');
      if (buyBtn) buyBtn.addEventListener('click', ev => { ev.stopPropagation(); ev.preventDefault(); buyItem(p.id); });
    });
  } catch(e) {
    console.error("Failed to refresh statuses:", e);
  }
}


// EVENTS
el('search').addEventListener('input',debounce(()=>{visibleCount=24;render();},300));
el('setFilter').addEventListener('change',()=>{visibleCount=24;render();});
el('sort').addEventListener('change',()=>{render();});
el('loadMore').addEventListener('click',()=>{visibleCount+=24;render();});
el('refreshBtn').addEventListener('click',()=>loadProducts());
window.addEventListener('keydown',e=>{if(e.key==='Escape'){/* no modal */}});


// debounce util
function debounce(fn,wait=250){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);};}

// INIT
loadProducts();
setInterval(refreshStatuses, 3000);
</script>
</body>
</html>
