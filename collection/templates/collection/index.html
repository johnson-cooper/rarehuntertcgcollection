<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rare Hunter TCG — Store</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Subtle card shadow and smooth image zoom */
    .card-shadow { box-shadow: 0 8px 24px rgba(2,6,23,0.6); }
    .img-zoom { transition: transform .35s ease; }
    .img-zoom:hover { transform: scale(1.06); }
    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { background-position: -200px 0 } 100% { background-position: 200px 0 } }
    /* keep modal above */
    .modal-backdrop { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">

  <div class="max-w-7xl mx-auto px-4 py-6">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Rare Hunter TCG</h1>
        <p class="text-sm text-zinc-400 mt-1">Vintage singles • holos • 1st editions</p>
      </div>

      <div class="flex gap-2 items-center">
        <div class="text-sm text-zinc-400 hidden sm:block">Showing <span id="displayCount">0</span></div>
        <button id="refreshBtn" class="px-3 py-2 rounded bg-zinc-800 border border-zinc-700 hover:bg-zinc-700 text-sm">Refresh</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
      <div class="md:col-span-2 flex gap-3">
        <div class="flex-1">
          <label for="search" class="sr-only">Search</label>
          <input id="search" type="search" placeholder="Search name, konami id, set, edition..." class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>

        <select id="sort" aria-label="Sort" class="px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-800">
          <option value="featured">Featured</option>
          <option value="price_asc">Price: Low → High</option>
          <option value="price_desc">Price: High → Low</option>
        </select>
      </div>

      <select id="setFilter" class="px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-800">
        <option value="">All Sets</option>
      </select>
    </section>

    <!-- Grid -->
    <main>
      <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

      <!-- Load more -->
      <div class="mt-6 flex items-center justify-center gap-3">
        <button id="loadMore" class="px-5 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold">Load more</button>
      </div>
    </main>
  </div>

  <!-- Detail Modal / Lightbox -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 modal-backdrop" onclick="closeModal()" aria-hidden="true"></div>
    <div class="relative max-w-4xl w-full bg-zinc-900 rounded-2xl overflow-hidden card-shadow">
      <div class="md:flex">
        <div class="md:w-1/2 bg-black/20 flex items-center justify-center p-4">
          <img id="modalImg" src="" alt="" class="w-full h-[60vh] object-contain" />
        </div>
        <div class="md:w-1/2 p-5 space-y-3">
          <div class="flex items-start justify-between">
            <div>
              <h2 id="modalName" class="text-xl font-bold"></h2>
              <div id="modalSet" class="text-sm text-zinc-400"></div>
            </div>
            <button onclick="closeModal()" class="text-zinc-300 hover:text-white p-2" aria-label="Close">✕</button>
          </div>

          <div class="text-sm text-zinc-300" id="modalMeta"></div>

          <div class="mt-2">
            <div class="text-2xl font-extrabold" id="modalPrice"></div>
            <div class="text-xs text-zinc-400">mid: <span id="modalMid"></span> • source: <span id="modalSource"></span></div>
          </div>

          <div class="mt-2 text-sm text-zinc-300 space-y-1" id="modalNotes"></div>

          <div class="mt-4">
            <div id="modalInventory" class="text-sm text-zinc-300"></div>
            <div class="mt-3 flex gap-2">
              <button id="modalBuy" class="flex-1 px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Buy</button>
              <button id="modalReserve" class="flex-1 px-4 py-2 rounded bg-amber-500 hover:bg-amber-400">Reserve</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* Enhanced store script
   - uses /api/products/ (expects fields: id, name, price_cents, quantity, reserved, available, is_reserved, is_sold_out, image, set, edition, condition, misprint, graded, psa_grade)
   - POST to /api/create-checkout-session/ { collection_card_id, quantity }
*/

const API_LIST = '/api/products/';
const CHECKOUT = '/api/create-checkout-session/';

let allProducts = [];
let visibleCount = 24;
let observer = null;

// HELPERS
function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function formatMoney(cents){ if (cents === null || cents === undefined) return '—'; return '$' + Number(cents/100).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function el(id){ return document.getElementById(id); }

// SKELETON while loading
function showSkeleton(count=12){
  const grid = el('grid'); grid.innerHTML = '';
  for (let i=0;i<count;i++){
    const card = document.createElement('div');
    card.className = 'bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden animate-pulse';
    card.innerHTML = `
      <div style="aspect-ratio:4/5" class="skeleton"></div>
      <div class="p-3 space-y-2">
        <div class="h-4 w-3/4 skeleton rounded"></div>
        <div class="h-3 w-1/2 skeleton rounded"></div>
        <div class="h-4 w-1/3 skeleton rounded mt-3"></div>
      </div>
    `;
    grid.appendChild(card);
  }
}

// FETCH + INIT
async function loadProducts(){
  showSkeleton(10);
  try{
    const res = await fetch(API_LIST, { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Failed to load');
    allProducts = await res.json();
    populateSets();
    render();
    setupAutoLoad();
    el('displayCount').textContent = allProducts.length;
  }catch(e){
    const grid = el('grid');
    grid.innerHTML = `<div class="col-span-full p-6 text-center text-red-400">Could not load products: ${escapeHtml(e.message)}</div>`;
    console.error(e);
  }
}

// populate sets dropdown
function populateSets(){
  const sel = el('setFilter');
  const sets = [...new Set(allProducts.map(p => p.set?.name).filter(Boolean))].sort();
  sets.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
}

// Build card DOM (safe)
function buildCard(p){
  const quantity = (typeof p.quantity === 'number') ? p.quantity : (typeof p.available === 'number' ? p.available : null);
  const reserved = Number(p.reserved || 0);
  const available = (typeof p.available === 'number') ? p.available : Math.max(0, (quantity||0) - reserved);

  const status = p.is_sold_out ? 'soldout' : p.is_reserved ? 'reserved' : 'available';

  const card = document.createElement('article');
  card.className = 'bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden flex flex-col card-shadow transition-transform hover:scale-101';
  card.setAttribute('tabindex','0');
  card.innerHTML = `
    <div style="aspect-ratio:4/5" class="relative bg-zinc-800 overflow-hidden">
      <img data-src="${escapeHtml(p.image||'')}" alt="${escapeHtml(p.name)}" class="img-zoom w-full h-full object-cover" loading="lazy" />
      <div class="absolute left-3 top-3 px-2 py-1 rounded-full text-xs font-semibold ${status==='available' ? 'bg-emerald-100 text-emerald-900' : status==='reserved' ? 'bg-amber-100 text-amber-900' : 'bg-red-100 text-red-900'}">
        ${status==='available' ? 'Available' : status==='reserved' ? 'Reserved' : 'Sold out'}
      </div>
      <div class="absolute right-3 top-3 px-2 py-1 rounded bg-zinc-900/60 text-xs">${escapeHtml(p.set?.code||'')}</div>
      <button class="absolute inset-0 aria-hidden" data-action="open" style="background:transparent;border:0"></button>
    </div>
    <div class="p-3 flex flex-col gap-2 text-sm">
      <a href="/api/card/${p.id}/" class="font-semibold hover:underline">${escapeHtml(p.name)}</a>
      <div class="text-zinc-400 text-xs">${escapeHtml(p.set?.name||'')} ${p.edition ? '• ' + escapeHtml(p.edition) : ''} ${p.condition ? ' • ' + escapeHtml(p.condition) : ''}</div>
      <div class="flex items-center justify-between mt-2">
        <div>
          <div class="text-lg font-bold">${formatMoney(p.price_cents)}</div>
          <div class="text-xs text-zinc-400">mid: ${p.pricing?.mid ? formatMoney(Math.round(p.pricing.mid*100)) : '—'}</div>
        </div>
        <div class="text-right text-xs">
          <div class="${available>0 ? 'text-zinc-100' : 'text-red-400'}">Qty: ${quantity ?? '—'}</div>
          <div class="text-zinc-400">Reserved: ${reserved}</div>
        </div>
      </div>

      <div class="mt-3">
        ${ p.is_sold_out ? `<div class="px-3 py-2 bg-red-700 text-white rounded text-center font-semibold">Sold out</div>` :
           p.is_reserved ? `<div class="px-3 py-2 bg-amber-500 text-zinc-900 rounded text-center font-semibold">Reserved</div>` :
           `<button class="buy-btn w-full px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500 font-semibold" data-id="${p.id}">Buy</button>` }
      </div>
    </div>
  `;

  // lazy image: set src from data-src when in view
  const imgEl = card.querySelector('img');
  imgObserver.observe(imgEl);

  // open modal on overlay button or image click
  card.querySelector('[data-action="open"]').addEventListener('click', () => openModal(p));
  // Buy handler
  const buyBtn = card.querySelector('.buy-btn');
  if (buyBtn) buyBtn.addEventListener('click', () => buyItem(p.id));

  return card;
}

// IntersectionObserver for lazy images
const imgObserver = new IntersectionObserver((entries, obs) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      const img = e.target;
      const src = img.getAttribute('data-src');
      if (src) img.src = src;
      obs.unobserve(img);
    }
  });
}, { rootMargin: '200px' });

// render grid
function render(){
  const grid = el('grid');
  const q = el('search').value.trim().toLowerCase();
  const set = el('setFilter').value;
  const sort = el('sort').value;

  grid.innerHTML = '';

  // filter
  let filtered = allProducts.filter(p => {
    return (!q || p.name.toLowerCase().includes(q) || String(p.konami_id||'').includes(q))
      && (!set || (p.set && p.set.name === set));
  });

  // sort
  if (sort === 'price_asc') filtered.sort((a,b)=> (a.price_cents||0) - (b.price_cents||0));
  else if (sort === 'price_desc') filtered.sort((a,b)=> (b.price_cents||0) - (a.price_cents||0));
  // featured default keep API order

  const pageItems = filtered.slice(0, visibleCount);
  pageItems.forEach(p => grid.appendChild(buildCard(p)));

  el('displayCount').textContent = filtered.length;

  // show/hide load more
  el('loadMore').style.display = (filtered.length > visibleCount) ? 'inline-block' : 'none';
}

// modal
function openModal(p){
  el('modal').classList.remove('hidden');
  el('modalImg').src = p.image || '';
  el('modalImg').alt = p.name || '';
  el('modalName').textContent = p.name || '';
  el('modalSet').textContent = p.set ? `${p.set.name} ${p.set.code ? '• ' + p.set.code : ''}` : '';
  el('modalMeta').textContent = `${p.edition || ''}${p.edition && p.condition ? ' • ' : ''}${p.condition || ''}`;
  el('modalPrice').textContent = formatMoney(p.price_cents);
  el('modalMid').textContent = p.pricing?.mid ? formatMoney(Math.round(p.pricing.mid*100)) : '—';
  el('modalSource').textContent = p.pricing?.source || '—';
  el('modalNotes').innerHTML = p.misprint ? `<div class="text-yellow-400">⚠ ${escapeHtml(p.misprint)}</div>` : '';
  el('modalInventory').textContent = `Qty: ${p.quantity ?? '—'} • Reserved: ${p.reserved ?? 0} • Avail: ${p.available ?? '—'}`;

  // buy/reserve buttons
  const buyBtn = el('modalBuy');
  const reserveBtn = el('modalReserve');

  if (p.is_sold_out) {
    buyBtn.disabled = true; buyBtn.classList.add('opacity-60','cursor-not-allowed');
    reserveBtn.disabled = true; reserveBtn.classList.add('opacity-60','cursor-not-allowed');
  } else if (p.is_reserved) {
    buyBtn.disabled = false; buyBtn.classList.remove('opacity-60','cursor-not-allowed');
    reserveBtn.disabled = false; reserveBtn.classList.remove('opacity-60','cursor-not-allowed');
  } else {
    buyBtn.disabled = false; reserveBtn.disabled = false;
  }

  buyBtn.onclick = () => buyItem(p.id);
  reserveBtn.onclick = () => reserveItem(p.id);
  // trap focus? keep simple
}

function closeModal(){
  el('modal').classList.add('hidden');
  el('modalImg').src = '';
}

// buy
async function buyItem(id){
  try{
    const res = await fetch(CHECKOUT, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ collection_card_id: id, quantity: 1 })
    });
    const j = await res.json();
    if (j.url) window.location = j.url;
    else alert(j.error || 'Checkout failed');
  }catch(e){
    alert('Checkout error: ' + e.message);
  }
}

// reserve (simple client -> server call)
async function reserveItem(id){
  try{
    const res = await fetch(`/api/collectioncards/${id}/reserve/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': (document.cookie.match(/(^| )csrftoken=([^;]+)/)||[])[2] || '' },
      body: JSON.stringify({ quantity: 1 })
    });
    if (!res.ok) throw new Error('Reserve failed');
    showToast('Reserved — check admin to capture payment.');
    // refresh
    await loadProducts();
    closeModal();
  }catch(e){
    alert('Reserve failed: ' + e.message);
  }
}

// toast
function showToast(msg){
  const t = document.createElement('div');
  t.className = 'fixed bottom-6 right-6 bg-zinc-800 text-zinc-100 px-4 py-2 rounded shadow-lg';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 3500);
}

// auto-load when scrolled near bottom (optional)
function setupAutoLoad(){
  if (observer) observer.disconnect();
  const sentinel = document.createElement('div');
  document.querySelector('main').appendChild(sentinel);
  observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        visibleCount += 24;
        render();
      }
    });
  }, { rootMargin: '400px' });
  observer.observe(sentinel);
}

// events
el('search').addEventListener('input', debounce(()=> { visibleCount = 24; render(); }, 300));
el('setFilter').addEventListener('change', ()=> { visibleCount = 24; render(); });
el('sort').addEventListener('change', ()=> { render(); });
el('loadMore').addEventListener('click', ()=> { visibleCount += 24; render(); });
el('refreshBtn').addEventListener('click', ()=> loadProducts());
window.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeModal(); });

// debounce util
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

// init
loadProducts();

</script>
</body>
</html>
