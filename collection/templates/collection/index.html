<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <header class="bg-white shadow p-4 mb-6">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-3xl font-bold text-gray-800">Rare Hunter TCG Store</h1>
      <input id="searchInput" type="text" placeholder="Search cards..."
             class="border rounded px-3 py-1 w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
  </header>

  <main class="container mx-auto">
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <div class="flex justify-center mt-6 space-x-2">
      <button id="prevPage" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 disabled:bg-gray-300" disabled>Prev</button>
      <button id="nextPage" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 disabled:bg-gray-300">Next</button>
    </div>
  </main>

  <script>
    let products = [];
    let currentPage = 1;
    const pageSize = 12;
    const grid = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');

    async function loadProducts() {
      const res = await fetch('/api/products/');
      products = await res.json();
      renderPage();
    }

    function renderPage() {
      const search = searchInput.value.toLowerCase();
      let filtered = products.filter(p => p.name.toLowerCase().includes(search) || (p.card_set?.name || '').toLowerCase().includes(search));
      
      const totalPages = Math.ceil(filtered.length / pageSize);
      currentPage = Math.min(currentPage, totalPages) || 1;

      const start = (currentPage - 1) * pageSize;
      const pageItems = filtered.slice(start, start + pageSize);

      grid.innerHTML = '';
      pageItems.forEach(p => {
        const availableQty = (p.quantity - (p.reserved || 0));
        const isSoldOut = availableQty <= 0;

        const cardEl = document.createElement('div');
        cardEl.className = 'bg-white shadow rounded overflow-hidden flex flex-col';
        cardEl.innerHTML = `
          <img src="${p.image || ''}" alt="${p.name}" class="h-48 w-full object-cover">
          <div class="p-4 flex flex-col flex-1">
            <h3 class="font-bold text-lg mb-1">${p.name}</h3>
            <p class="text-sm text-gray-500 mb-1">Set: ${p.card_set?.name || 'N/A'}</p>
            <p class="text-sm text-gray-500 mb-1">Edition: ${p.edition || 'Unlimited'}</p>
            <p class="text-sm text-gray-500 mb-1">Condition: ${p.condition || 'N/A'}</p>
            <p class="text-sm mb-1">Price: <span class="font-semibold">$${(p.effective_mid||0).toFixed(2)}</span></p>
            <p class="text-sm mb-2">Available: ${availableQty} | Reserved: ${p.reserved || 0}</p>
            <button onclick="buy(${p.id})"
              class="mt-auto px-4 py-2 rounded text-white font-semibold ${isSoldOut ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600'}"
              ${isSoldOut ? 'disabled' : ''}>
              ${isSoldOut ? 'Sold Out' : 'Request to Buy'}
            </button>
          </div>
        `;
        grid.appendChild(cardEl);
      });

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    searchInput.addEventListener('input', () => {
      currentPage = 1;
      renderPage();
    });

    prevBtn.addEventListener('click', () => {
      currentPage--;
      renderPage();
    });
    nextBtn.addEventListener('click', () => {
      currentPage++;
      renderPage();
    });

    async function buy(id) {
      try {
        const res = await fetch('/api/create-checkout-session/', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({collection_card_id: id, quantity: 1})
        });
        const j = await res.json();
        if (j.url) window.location = j.url;
        else alert('Error: ' + (j.error || 'unknown'));
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    loadProducts();
  </script>

</body>
</html>