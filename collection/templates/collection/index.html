<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rare Hunter TCG</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-950 text-zinc-100">

  <div class="max-w-7xl mx-auto px-4 py-6">

    <h1 class="text-2xl font-bold mb-4">Card Store</h1>

    <!-- Filters -->
    <div class="flex flex-col sm:flex-row gap-3 mb-6">
      <input
        id="search"
        placeholder="Search card name…"
        class="w-full sm:w-1/2 bg-zinc-900 border border-zinc-700 rounded px-3 py-2"
      />

      <select
        id="setFilter"
        class="w-full sm:w-1/3 bg-zinc-900 border border-zinc-700 rounded px-3 py-2"
      >
        <option value="">All Sets</option>
      </select>
    </div>

    <!-- Grid -->
    <div
      id="grid"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
    ></div>

    <!-- Load more -->
    <div class="text-center mt-6">
      <button
        id="loadMore"
        class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500"
      >
        Load more
      </button>
    </div>

  </div>

<script>
let allProducts = []
let visibleCount = 40

async function loadProducts() {
  const res = await fetch('/api/products/')
  allProducts = await res.json()

  populateSets()
  render()
}

function populateSets() {
  const select = document.getElementById('setFilter')
  const sets = [...new Set(allProducts.map(p => p.set?.name).filter(Boolean))]

  sets.forEach(s => {
    const opt = document.createElement('option')
    opt.value = s
    opt.textContent = s
    select.appendChild(opt)
  })
}

function render() {
  const grid = document.getElementById('grid')
  const search = document.getElementById('search').value.toLowerCase()
  const set = document.getElementById('setFilter').value

  grid.innerHTML = ''

  const filtered = allProducts.filter(p => {
    return (
      p.name.toLowerCase().includes(search) &&
      (!set || p.set?.name === set)
    )
  })

  filtered.slice(0, visibleCount).forEach(p => {
    const el = document.createElement('div')
    el.className = `
      bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden
      flex flex-col
    `

    el.innerHTML = `
      <img src="${p.image || ''}" class="h-36 object-cover w-full" />
      <div class="p-3 flex flex-col gap-1 text-sm">
        <a href="/api/card/${p.id}/" class="font-semibold hover:underline">
        ${p.name}
        </a>
        <div class="text-zinc-400">${p.set?.code || ''}</div>
        <div>${p.condition} • ${p.edition}</div>

        ${p.misprint ? `<div class="text-yellow-400">⚠ ${p.misprint}</div>` : ''}
        ${p.graded ? `<div class="text-green-400">PSA ${p.psa_grade}</div>` : ''}

        <div class="mt-2 font-bold">$${(p.price_cents / 100).toFixed(2)}</div>

        ${
          p.is_sold_out
          ? `<div class="text-red-400 mt-1">Sold out</div>`
          : `<button onclick="buy(${p.id})"
              class="mt-2 bg-indigo-600 hover:bg-indigo-500 rounded px-3 py-1">
              Buy
            </button>`
        }
      </div>
    `

    grid.appendChild(el)
  })
}

document.getElementById('search').oninput = render
document.getElementById('setFilter').onchange = render
document.getElementById('loadMore').onclick = () => {
  visibleCount += 40
  render()
}

async function buy(id) {
  const res = await fetch('/api/create-checkout-session/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ collection_card_id: id, quantity: 1 })
  })
  const j = await res.json()
  if (j.url) window.location = j.url
  else alert(j.error || 'Error')
}

loadProducts()
</script>

</body>
</html>
